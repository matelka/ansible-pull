#!/bin/bash

# Définissez vos fichiers de variables dans un tableau (array)
# Séparez chaque chemin par un espace.
VAR_FILES=(
    "/home/maitelka/script/etd.sh"
    "/home/maitelka/script/ed.sh"
    "/home/maitelka/script/ms.sh"
)

# Répertoire contenant les scripts à vérifier
SCRIPTS_DIR="/home/maitelka/script/toCheck"

VARS_TOTAL=0
VARS_USED=0
VARS_UNUSED=0

echo "Vérification des variables définies dans les fichiers de configuration..."
echo "Recherche dans : $SCRIPTS_DIR"
echo "---------------------------------------------------"

# Récupération des variables exportées à partir de TOUS les fichiers
# Les variables sont stockées dans un tableau associatif pour garder leur fichier d'origine
declare -A VARS
VARS_RAW_COUNT=0

for file in "${VAR_FILES[@]}"; do
    if [ -f "$file" ]; then
        # On extrait les variables du fichier
        file_vars=$(grep -oP '^[[:space:]]*export[[:space:]]+[A-Z_][A-Z0-9_]*' "$file" | awk '{print $NF}')
        
        # On stocke chaque variable avec son chemin de fichier d'origine
        while read -r var_name; do
            if [[ -n "$var_name" ]]; then
                if [[ ! -v VARS["$var_name"] ]]; then
                    VARS["$var_name"]="$file"
                    ((VARS_TOTAL++))
                fi
                ((VARS_RAW_COUNT++))
            fi
        done <<< "$file_vars"
    else
        echo "Avertissement: Le fichier $file n'existe pas ou n'est pas accessible. Il sera ignoré."
    fi
done

echo "## Variables qui NE sont PAS utilisées :"

# Construire la liste d'exclusion pour grep
EXCLUDE_FILES=""
for file in "${VAR_FILES[@]}"; do
    EXCLUDE_FILES+=" --exclude=$file"
done

# Vérifier chaque variable stockée dans le tableau associatif
for var_name in "${!VARS[@]}"; do
    if eval grep -R -q -D skip "$EXCLUDE_FILES" "$var_name" "$SCRIPTS_DIR" 2>/dev/null; then
        ((VARS_USED++))
    else
        echo "∆ $var_name n'est pas utilisé (trouvé dans: ${VARS[$var_name]})"
        ((VARS_UNUSED++))
    fi
done

echo "---------------------------------------------------"
echo "### Statistiques de la vérification"
echo "Total de variables uniques      : $VARS_TOTAL"
echo "Doublons trouvés et traités    : $(( VARS_RAW_COUNT - VARS_TOTAL ))"
echo "Variables utilisées            : $VARS_USED"
echo "Variables non utilisées        : $VARS_UNUSED"
echo "---------------------------------------------------"
echo "Vérification terminée."
