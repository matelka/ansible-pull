#!/bin/bash

# Définissez vos fichiers de variables dans un tableau (array)
# Séparez chaque chemin par un espace.
VAR_FILES=(
    "/home/maitelka/script/.sh"
    "/home/maitelka/script/.sh"
    "/home/maitelka/script/.sh"
)

# Répertoire contenant les scripts à vérifier
SCRIPTS_DIR="/home/maitelka/script/teck"

VARS_TOTAL=0
VARS_USED=0
VARS_UNUSED=0

echo "Vérification des variables définies dans les fichiers de configuration..."
echo "Recherche dans : $SCRIPTS_DIR"
echo "---------------------------------------------------"

# Récupération des variables exportées à partir de TOUS les fichiers
# La boucle parcourt le tableau VAR_FILES pour extraire les variables de chaque fichier.
VARS_RAW=""
for file in "${VAR_FILES[@]}"; do
    if [ -f "$file" ]; then
        VARS_RAW+=$(grep -oP '^[[:space:]]*export[[:space:]]+[A-Z_][A-Z0-9_]*' "$file" | awk '{print $NF}' | tr '\n' ' ')
    else
        echo "Avertissement: Le fichier $file n'existe pas ou n'est pas accessible. Il sera ignoré."
    fi
done

# Convertir la chaîne en liste et supprimer les doublons
VARS=$(echo "$VARS_RAW" | tr ' ' '\n' | sort -u)

# Décompte du total des variables uniques
VARS_TOTAL=$(echo "$VARS" | wc -l)

echo "## Variables qui NE sont PAS utilisées :"

for var in $VARS; do
    
    # On ajoute la liste des fichiers à exclure
    EXCLUDE_FILES=""
    for file in "${VAR_FILES[@]}"; do
        EXCLUDE_FILES+=" --exclude=$file"
    done

    # Exécution du grep en utilisant la liste d'exclusions
    if eval grep -R -q -D skip "$EXCLUDE_FILES" "$var" "$SCRIPTS_DIR" 2>/dev/null; then
        VARS_USED=$((VARS_USED + 1))
    else
        echo "∆ $var n'est pas utilisé"
        VARS_UNUSED=$((VARS_UNUSED + 1))
    fi
done

echo "---------------------------------------------------"
echo "### Statistiques de la vérification"
echo "Total de variables uniques      : $VARS_TOTAL"
echo "Variables utilisées             : $VARS_USED"
echo "Variables non utilisées         : $VARS_UNUSED"

echo "---------------------------------------------------"
echo "Vérification terminée."
